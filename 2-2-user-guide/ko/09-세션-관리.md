# 세션 관리

## 핵심 개념
- 에이전트당 **하나의 메인 세션**으로 DM 처리
- 그룹/채널 채팅은 격리된 세션

## 세션 키

| 소스 | 키 형식 |
|------|--------|
| DM (기본) | `agent:<agentId>:main` |
| DM (발신자별) | `agent:<agentId>:dm:<peerId>` |
| 그룹 | `agent:<agentId>:<channel>:group:<id>` |
| 크론 | `cron:<jobId>` |
| 웹훅 | `hook:<uuid>` |

## DM 범위 옵션

```json5
{
  session: {
    dmScope: "main"  // main | per-peer | per-channel-peer | per-account-channel-peer
  }
}
```

- `main`: 모든 DM이 한 세션 공유 (연속성)
- `per-peer`: 발신자별 격리
- `per-channel-peer`: 채널 + 발신자별 격리
- `per-account-channel-peer`: 계정 + 채널 + 발신자별 격리

## 상태 저장 위치
- 저장소: `~/.openclaw/agents/<agentId>/sessions/sessions.json`
- 기록: `~/.openclaw/agents/<agentId>/sessions/<SessionId>.jsonl`

## 세션 수명주기

### 리셋 트리거
- 매일: 오전 4시 로컬 (기본)
- 유휴: 설정 가능한 `idleMinutes`
- 수동: `/new` 또는 `/reset` 명령

### 설정 예시
```json5
{
  session: {
    reset: {
      mode: "daily",
      atHour: 4,
      idleMinutes: 120
    },
    resetByType: {
      dm: { mode: "idle", idleMinutes: 240 },
      group: { mode: "idle", idleMinutes: 120 }
    }
  }
}
```

## 전송 정책
특정 세션 유형의 전달 차단:

```json5
{
  session: {
    sendPolicy: {
      rules: [
        { action: "deny", match: { channel: "discord", chatType: "group" } },
        { action: "deny", match: { keyPrefix: "cron:" } }
      ],
      default: "allow"
    }
  }
}
```

런타임 오버라이드: `/send on|off|inherit`

## 신원 링크
채널 간 같은 사람 매핑:

```json5
{
  session: {
    identityLinks: {
      alice: ["telegram:123456789", "discord:987654321"]
    }
  }
}
```

## 채팅 명령
- `/status` - 에이전트 상태 + 컨텍스트 사용량 확인
- `/context list` - 시스템 프롬프트 내용 보기
- `/new` - 새 세션 시작
- `/new <model>` - 모델 오버라이드로 새 세션
- `/stop` - 현재 실행 중단
- `/compact` - 오래된 컨텍스트 요약

## 검사

```bash
# 최근 세션 표시
openclaw status

# 모든 세션 목록
openclaw sessions --json

# 활성 세션 필터
openclaw sessions --active 60
```

## 세션 프루닝
LLM 호출 전에 오래된 도구 결과를 메모리 내 컨텍스트에서 제거.
JSONL 히스토리는 다시 쓰지 않음 (기록 보존).
